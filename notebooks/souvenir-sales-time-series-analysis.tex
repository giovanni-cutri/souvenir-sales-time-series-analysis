% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Souvenir Sales Time Series Analysis},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Souvenir Sales Time Series Analysis}
\author{}
\date{\vspace{-2.5em}}

\begin{document}
\maketitle

\hypertarget{souvenir-sales---time-series-analysis}{%
\section{Souvenir Sales - Time Series
Analysis}\label{souvenir-sales---time-series-analysis}}

The following is a statistical analysis on a monthly time series which
collects data about the sales of a souvenir shop in Australia in the
period between 1987 and 1992.

The analysis will roughly follow the Box-Jenkins method and will focus
on reaching stationarity for the time series, estimating a SARIMA model
and predicting future values.

\hypertarget{data-exploration}{%
\subsection{Data exploration}\label{data-exploration}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: il pacchetto 'lubridate' Ã¨ stato creato con R versione 4.2.3
\end{verbatim}

\begin{verbatim}
## -- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
## v dplyr     1.1.0     v readr     2.1.4
## v forcats   1.0.0     v stringr   1.5.0
## v ggplot2   3.4.1     v tibble    3.2.0
## v lubridate 1.9.2     v tidyr     1.3.0
## v purrr     1.0.1     
## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()
## i Use the ]8;;http://conflicted.r-lib.org/conflicted package]8;; to force all conflicts to become errors
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tsdl)}
\FunctionTok{library}\NormalTok{(tseries)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: il pacchetto 'tseries' Ã¨ stato creato con R versione 4.2.3
\end{verbatim}

\begin{verbatim}
## Registered S3 method overwritten by 'quantmod':
##   method            from
##   as.zoo.data.frame zoo
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tsibble)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: il pacchetto 'tsibble' Ã¨ stato creato con R versione 4.2.3
\end{verbatim}

\begin{verbatim}
## 
## Caricamento pacchetto: 'tsibble'
## 
## Il seguente oggetto Ã¨ mascherato da 'package:lubridate':
## 
##     interval
## 
## I seguenti oggetti sono mascherati da 'package:base':
## 
##     intersect, setdiff, union
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(feasts)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: il pacchetto 'feasts' Ã¨ stato creato con R versione 4.2.3
\end{verbatim}

\begin{verbatim}
## Caricamento del pacchetto richiesto: fabletools
\end{verbatim}

\begin{verbatim}
## Warning: il pacchetto 'fabletools' Ã¨ stato creato con R versione 4.2.3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(forecast)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Caricamento pacchetto: 'forecast'
## 
## Il seguente oggetto Ã¨ mascherato da 'package:fabletools':
## 
##     accuracy
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(lmtest)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Caricamento del pacchetto richiesto: zoo
## 
## Caricamento pacchetto: 'zoo'
## 
## Il seguente oggetto Ã¨ mascherato da 'package:tsibble':
## 
##     index
## 
## I seguenti oggetti sono mascherati da 'package:base':
## 
##     as.Date, as.Date.numeric
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ldsr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: il pacchetto 'ldsr' Ã¨ stato creato con R versione 4.2.3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(tsdl, }\DecValTok{12}\NormalTok{, }\StringTok{"sales"}\NormalTok{, }\AttributeTok{description =} \StringTok{"Queensland"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
\FunctionTok{attributes}\NormalTok{(data)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $tsp
## [1] 1987.000 1993.917   12.000
## 
## $class
## [1] "ts"
## 
## $source
## [1] "Makridakis, Wheelwright and Hyndman (1998)"
## 
## $description
## [1] "Monthly sales for a souvenir shop on the wharf at a beach resort town in Queensland, Australia. Jan 1987-Dec 1993"
## 
## $subject
## [1] "Sales"
\end{verbatim}

Now that we have imported the time series, let's have a first look at
its values.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as\_tsibble}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{head}\NormalTok{(}\AttributeTok{n =} \DecValTok{72}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{rename}\NormalTok{(}\AttributeTok{date =}\NormalTok{ index, }\AttributeTok{sales =}\NormalTok{ value)}
\NormalTok{tseries}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tsibble: 72 x 2 [1M]
##        date sales
##       <mth> <dbl>
##  1 1987 gen 1665.
##  2 1987 feb 2398.
##  3 1987 mar 2841.
##  4 1987 apr 3547.
##  5 1987 mag 3753.
##  6 1987 giu 3715.
##  7 1987 lug 4350.
##  8 1987 ago 3566.
##  9 1987 set 5022.
## 10 1987 ott 6423.
## # i 62 more rows
\end{verbatim}

\hypertarget{check-for-non-stationarity}{%
\subsection{Check for
non-stationarity}\label{check-for-non-stationarity}}

Let's make a plot and see what we can say about it.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ date, }\AttributeTok{y =}\NormalTok{ sales)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-4-1.pdf}

From the plot of the series, we can already grasp that it is not
stationary, as the expected value is not constant over time and neither
is variance, which tends to increase. In particular, we can speculate
the presence of an upward trend and a seasonal effect, which is
comprehensible, considering the tourist vocation of the shop.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{gg\_season}\NormalTok{(sales) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-5-1.pdf}

To better appreciate it, this plot shows the data for each year
separately. The values of the series are clearly higher for the latest
years and there is a recurring peak in the months of March and August,
followed by a valley in October.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ACF}\NormalTok{(sales) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{autoplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-6-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{PACF}\NormalTok{(sales) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{autoplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-7-1.pdf}

Lastly, these are the \emph{global} and \emph{partial autocorrelation
functions} for the series. The slow decay for the ACF suggests, once
again, the existence of a trend, while the spikes at lag 12 indicate a
probable seasonality.

To formalize our guesses, let's resort to two statistical test: - The
\textbf{Augmented Dickey-Fuller test} tests the null hypothesis of the
presence of a unit root in our time series - The \textbf{KPSS test}
tests the null hypothesis that our data is stationary

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as.ts}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{adf.test}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Augmented Dickey-Fuller Test
## 
## data:  .
## Dickey-Fuller = -1.2891, Lag order = 4, p-value = 0.8648
## alternative hypothesis: stationary
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as.ts}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{kpss.test}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in kpss.test(.): p-value smaller than printed p-value
\end{verbatim}

\begin{verbatim}
## 
##  KPSS Test for Level Stationarity
## 
## data:  .
## KPSS Level = 0.98879, Truncation lag parameter = 3, p-value = 0.01
\end{verbatim}

We were expecting to reject H0 for \textbf{KPSS} and not be able to
reject it for \textbf{ADF} and that's exactly what happened, looking at
the p-values.

\hypertarget{reach-stationarity}{%
\subsection{Reach stationarity}\label{reach-stationarity}}

In order to obtain stationarity in our time series, we need to perform a
series of operations: we are going to stabilize the variance through the
\emph{Box-Cox transformation} and then apply differencing to treat trend
and seasonality.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lambda }\OtherTok{\textless{}{-}} \FunctionTok{BoxCox.lambda}\NormalTok{(tseries}\SpecialCharTok{$}\NormalTok{sales)}
\NormalTok{bc }\OtherTok{\textless{}{-}} \FunctionTok{BoxCox}\NormalTok{(tseries}\SpecialCharTok{$}\NormalTok{sales, }\AttributeTok{lambda =}\NormalTok{ lambda)}
\NormalTok{tseries.novar }\OtherTok{\textless{}{-}}\NormalTok{ tseries }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{sales =}\NormalTok{ bc)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.novar }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ date, }\AttributeTok{y =}\NormalTok{ sales)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Time series with stabilized variance"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-11-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff }\OtherTok{\textless{}{-}}\NormalTok{ tseries.novar }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{date =}\NormalTok{ date, }\AttributeTok{sales =} \FunctionTok{difference}\NormalTok{(sales, }\AttributeTok{lag =} \DecValTok{1}\NormalTok{, }\AttributeTok{differences =} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{slice\_tail}\NormalTok{(}\AttributeTok{n =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{tseries.diff}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tsibble: 71 x 2 [1M]
##        date    sales
##       <mth>    <dbl>
##  1 1987 feb  0.0465 
##  2 1987 mar  0.0201 
##  3 1987 apr  0.0250 
##  4 1987 mag  0.00610
##  5 1987 giu -0.00110
##  6 1987 lug  0.0166 
##  7 1987 ago -0.0211 
##  8 1987 set  0.0356 
##  9 1987 ott  0.0237 
## 10 1987 nov  0.0153 
## # i 61 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ date, }\AttributeTok{y =}\NormalTok{ sales)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Time series with first order differencing"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-13-1.pdf}

The first order differencing removes trend, but leaves seasonality.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff.s }\OtherTok{\textless{}{-}}\NormalTok{ tseries.novar }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{sales =} \FunctionTok{difference}\NormalTok{(sales, }\AttributeTok{lag =} \DecValTok{12}\NormalTok{, }\AttributeTok{differences =} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{slice\_tail}\NormalTok{(}\AttributeTok{n=} \SpecialCharTok{{-}}\DecValTok{12}\NormalTok{)}
\NormalTok{tseries.diff.s}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tsibble: 60 x 2 [1M]
##        date    sales
##       <mth>    <dbl>
##  1 1988 gen  0.0516 
##  2 1988 feb  0.0847 
##  3 1988 mar  0.0956 
##  4 1988 apr  0.0318 
##  5 1988 mag  0.0458 
##  6 1988 giu  0.0298 
##  7 1988 lug  0.0346 
##  8 1988 ago  0.0301 
##  9 1988 set  0.00886
## 10 1988 ott -0.00904
## # i 50 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff.s }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ date, }\AttributeTok{y =}\NormalTok{ sales)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Time series with first order seasonal differencing"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-15-1.pdf}

The seasonal differencing removes seasonality, but leaves trend.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff.final }\OtherTok{\textless{}{-}}\NormalTok{ tseries.novar }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{sales =} \FunctionTok{difference}\NormalTok{(sales, }\AttributeTok{lag =} \DecValTok{1}\NormalTok{, }\AttributeTok{differences =} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{slice\_tail}\NormalTok{(}\AttributeTok{n =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{sales =} \FunctionTok{difference}\NormalTok{(sales, }\AttributeTok{lag =} \DecValTok{12}\NormalTok{, }\AttributeTok{differences =} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{slice\_tail}\NormalTok{ (}\AttributeTok{n =} \SpecialCharTok{{-}}\DecValTok{12}\NormalTok{)}
\NormalTok{tseries.diff.final}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tsibble: 59 x 2 [1M]
##        date    sales
##       <mth>    <dbl>
##  1 1988 feb  0.0332 
##  2 1988 mar  0.0109 
##  3 1988 apr -0.0638 
##  4 1988 mag  0.0140 
##  5 1988 giu -0.0160 
##  6 1988 lug  0.00479
##  7 1988 ago -0.00449
##  8 1988 set -0.0212 
##  9 1988 ott -0.0179 
## 10 1988 nov  0.0510 
## # i 49 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff.final }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ggplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ date, }\AttributeTok{y =}\NormalTok{ sales)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-17-1.pdf}

The new series should be stationary now. Let's check with our two tests.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff.final }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as.ts}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{adf.test}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in adf.test(.): p-value smaller than printed p-value
\end{verbatim}

\begin{verbatim}
## 
##  Augmented Dickey-Fuller Test
## 
## data:  .
## Dickey-Fuller = -6.0066, Lag order = 3, p-value = 0.01
## alternative hypothesis: stationary
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff.final }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as.ts}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{kpss.test}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in kpss.test(.): p-value greater than printed p-value
\end{verbatim}

\begin{verbatim}
## 
##  KPSS Test for Level Stationarity
## 
## data:  .
## KPSS Level = 0.068468, Truncation lag parameter = 3, p-value = 0.1
\end{verbatim}

Our conclusions on the null hypothesis have now switched, as we
expected.

Let's look at the ACF and PACF.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff.final }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ACF}\NormalTok{(sales, }\AttributeTok{lag\_max =} \DecValTok{24}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{autoplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-20-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.diff.final }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{PACF}\NormalTok{(sales, }\AttributeTok{lag\_max =} \DecValTok{24}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{autoplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-21-1.pdf}

\hypertarget{estimate-arima-model}{%
\subsection{Estimate ARIMA model}\label{estimate-arima-model}}

At this point, we should be able to estimate the values for the
parameters of our ARIMA model by looking at these two plots and the
spikes in them. However, the most reliable way to actually determine the
parameters is using an objective procedure, for example a stepwise-like,
and let a computer do it for us by choosing among many ARIMA models the
``best'' one, in terms of optimizing a certain indicator.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit }\OtherTok{\textless{}{-}}\NormalTok{ tseries }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as.ts}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{auto.arima}\NormalTok{(}\AttributeTok{start.p =} \DecValTok{1}\NormalTok{,}\AttributeTok{start.q =} \DecValTok{1}\NormalTok{, }\AttributeTok{max.p =} \DecValTok{3}\NormalTok{, }\AttributeTok{max.q =} \DecValTok{3}\NormalTok{,}
             \AttributeTok{start.P =} \DecValTok{0}\NormalTok{, }\AttributeTok{seasonal =}\NormalTok{ T, }\AttributeTok{d =} \DecValTok{1}\NormalTok{, }\AttributeTok{D =} \DecValTok{1}\NormalTok{, }\AttributeTok{trace =}\NormalTok{ T,}
             \AttributeTok{stepwise =}\NormalTok{ T, }\AttributeTok{lambda =} \StringTok{"auto"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  ARIMA(1,1,1)(0,1,1)[12]                    : -3.783953
##  ARIMA(0,1,0)(0,1,0)[12]                    : 12.95279
##  ARIMA(1,1,0)(1,1,0)[12]                    : -3.506572
##  ARIMA(0,1,1)(0,1,1)[12]                    : -4.677704
##  ARIMA(0,1,1)(0,1,0)[12]                    : -1.072194
##  ARIMA(0,1,1)(1,1,1)[12]                    : Inf
##  ARIMA(0,1,1)(0,1,2)[12]                    : Inf
##  ARIMA(0,1,1)(1,1,0)[12]                    : -2.863223
##  ARIMA(0,1,1)(1,1,2)[12]                    : Inf
##  ARIMA(0,1,0)(0,1,1)[12]                    : 11.30466
##  ARIMA(0,1,2)(0,1,1)[12]                    : -2.804183
##  ARIMA(1,1,0)(0,1,1)[12]                    : -5.843042
##  ARIMA(1,1,0)(0,1,0)[12]                    : -0.9084839
##  ARIMA(1,1,0)(1,1,1)[12]                    : Inf
##  ARIMA(1,1,0)(0,1,2)[12]                    : -4.464014
##  ARIMA(1,1,0)(1,1,2)[12]                    : Inf
##  ARIMA(2,1,0)(0,1,1)[12]                    : -3.737659
##  ARIMA(2,1,1)(0,1,1)[12]                    : -1.63897
## 
##  Best model: ARIMA(1,1,0)(0,1,1)[12]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{coeftest}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## z test of coefficients:
## 
##      Estimate Std. Error z value  Pr(>|z|)    
## ar1  -0.52834    0.10898 -4.8480 1.247e-06 ***
## sma1 -0.57352    0.22209 -2.5824  0.009812 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

The chosen model appears to be \emph{ARIMA(1,1,0)(0,1,1){[}12{]}}. Along
with it, we have also got a number of diagnostic tools: we can see that
the parameters are significantly different than 0.

Let's look at other diagnostic measures through some plots.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{checkresiduals}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-24-1.pdf}

\begin{verbatim}
## 
##  Ljung-Box test
## 
## data:  Residuals from ARIMA(1,1,0)(0,1,1)[12]
## Q* = 10.467, df = 12, p-value = 0.575
## 
## Model df: 2.   Total lags used: 14
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qqnorm}\NormalTok{(fit}\SpecialCharTok{$}\NormalTok{residuals)}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-24-2.pdf}

The residuals roughly follow a normal distribution, as deduced from the
histogram and the Q-Q plot, but they seem to follow a pattern in their
time series, which is not good for our model.

\hypertarget{forecast}{%
\subsection{Forecast}\label{forecast}}

For the last step, let's try to forecast some future values, in
particular 12 more observations, and plot the result.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tseries.forecast }\OtherTok{\textless{}{-}} \FunctionTok{forecast}\NormalTok{(fit, }\AttributeTok{h =} \DecValTok{12}\NormalTok{)}
\NormalTok{tseries.forecast }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{autoplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{souvenir-sales-time-series-analysis_files/figure-latex/unnamed-chunk-25-1.pdf}

\end{document}
